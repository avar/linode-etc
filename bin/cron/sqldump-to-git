#!/bin/sh

if test -z "$type"; then
    echo "$0: You must supply a database type=, e.g. mysql or sqlite"
    exit 1
fi

if test -z "$database"; then
    echo "$0: You must supply a database= to dump"
    exit 1
fi

case "$type" in
    mysql)
        if ! test -d /var/lib/mysql/$database; then
            echo "$0: $database is an invalid database name, it doesn't exist in /var/lib/mysql/"
            exit 1
        fi

        backup_dir=/var/backup/mysql

        break
        ;;
    sqlite)
        if ! test -f $database; then
            echo "$0: $database doesn't exist"
            exit 1
        fi

        if test -z "$shortname"; then
            echo "$0: You must supply a database shortname=, e.g. smolder"
            exit 1
        fi

        backup_dir=/var/backup/sqlite

        break
        ;;
    *)
        echo "$0: Unknown database type $type"
        exit 1
        ;;
esac

# Dump it
case "$type" in
    mysql)
        database_dir="$backup_dir/$database"
        mkdir -p $database_dir 
        cd $database_dir
        mysqldump \
            -u"$user" \
            -p"$password" \
            --skip-extended-insert $database \
            --compact \
            > $database.sql
        break
        ;;
    sqlite)
        database_dir="$backup_dir/$shortname"
        mkdir -p $database_dir 
        cd $database_dir
        sqlite3 $database '.dump' > $shortname.sql
        break
        ;;
esac



if ! test -d .git; then
    git init >/dev/null
fi

GIT_AUTHOR_NAME="sqldump on v.nix.is"
GIT_AUTHOR_EMAIL="sqldump@v.nix.is"
export GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL

git add *.sql
git commit -m"Bumping $database MySQL dump" > /dev/null
