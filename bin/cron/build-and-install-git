#!/bin/sh

# Exit on errors
trap 'fail' ERR
fail () {
    code=$?
    echo "Failed with exit code $code"
    exit 1
}

j=10
prefix=/opt/git/pu
export GIT_NOTES_TIMING_TESTS=YesPlease
export GIT_TEST_HTTPD=YesPlease
export SVNSERVE_PORT=9876

dir=$(mktemp -d --tmpdir=/tmp "$(basename $0)-$(date --iso-8601)-XXXX")
test -n "$dir" || exit 1
echo "Working in $dir"
rm -rfv $dir
mkdir $dir

git clone --reference /home/avar/g/git git://git.kernel.org/pub/scm/git/git.git $dir
cd $dir
git checkout -t origin/pu

make -j$j prefix=$prefix CC=clang CFLAGS=-O3 V=1 all
cd $dir/t

# test it (again)
prove --shuffle -j $j ./t[0-9]*.sh :: --root=/dev/shm

# Install it
cd $dir
make -j $(($j / 3)) prefix=$prefix V=1 CC=clang CFLAGS=-O3 V=1 doc info
make -j $(($j / 3)) prefix=$prefix V=1 CC=clang CFLAGS=-O3 V=1 install install-doc install-html install-info

echo "Finished in $dir"
