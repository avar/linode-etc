#!/usr/bin/env perl
use 5.010;
use autodie qw[:all];
use strict;
use FindBin qw[$Bin];
use File::Path qw[remove_tree make_path];

remove_tree("$Bin/gen");

# All enabled sites in apache
chomp(my @ServerName = qx[ ack -h --follow 'ServerName\\s+(\\S+)' --output '\$1' /etc/apache2/sites-enabled/ | sort ]);

# All enabled aliases in apache
chomp(my @ServerAlias = qx[ ack -h --follow 'ServerAlias\\s+(.*)' --output '\$1'  /etc/apache2/sites-enabled/ | sort ]);
# Some have multiple aliases
@ServerAlias = map { split /\s+/, $_ } @ServerAlias;

# All enabled sites
my %sites_enabled;
@sites_enabled{@ServerName, @ServerAlias} = ();

my $TEMPLATE = <<"TEMPLATE";
#!$^X
# DO NOT EDIT, AUTOGENERATED
use FindBin qw[\$Bin];
use lib qq[\$Bin/../../lib];
use WebTest;
TEMPLATE

{
my @tests = (
    # 'ap.nix.is'              => qr/This server could not verify/, # TODO 401
    'aevar.net'                => qr/Bjarmason/,
    'awstats.nix.is'           => qr/Awstats/,
    'blog.nix.is'              => qr/literal thoughts/,
    'chanmirror.nix.is'        => q[Index of /],
    'ci.nix.is'                => qr/Powered by phpBB/,
    'dev.velfag.is'            => qr/MediaWiki/,
    'dev.xn--vlfag-bsa.is'     => qr/MediaWiki/,
    'downlode.org'             => qr/downlode/,
    'git.nix.is'               => qr/GitHub/,
    'grault.net'               => qr/Gosling Emacs documentation/,
    'hailo.nix.is'             => qr/Hailo Chat/,
    'hailo.org'                => qr/Hailo is a a pluggable/,
    'hw.mw.dev.avar.nix.is'    => qr/MediaWiki/,
    'leech.nix.is'             => qr/wTorrent/,
    'lists.nix.is'             => qr/Mailman/,
    'localhost'                => qr/How do I runned vee nix\?/,
    'munin.nix.is'             => qr/Munin/,
    'nix.is'                   => qr/logo\.png/,
    'noc.nix.is'               => qr/Network operations/,
    'osm.nix.is'               => qr/Garmin map of Iceland/,
    'smoke.git.nix.is'         => qr/Increase the visibility of your Smoke Tests/,
    'tms.nix.is'               => qr/Tumi/,
    'trunk.mw.dev.avar.nix.is' => qr/MediaWiki/,
    'tumi.nix.is'              => qr/Tumi/,
    'v.nix.is'                 => qr/vee nix/,
    'velfag.is'                => qr/MediaWiki/,
    'vnstat.nix.is'            => qr/vnstat\.cgi/,
    'voodootronix.com'         => qr/voodootronix/,
    'www.aevar.net'            => qr/Bjarmason/,
    'www.hailo.org'            => qr/Hailo is a a pluggable/,
    'www.velfag.is'            => qr/MediaWiki/,
    'www.voodootronix.com'     => qr/voodootronix/,
    'www.xn--var-xla.net'      => qr/Bjarmason/,
    'www.xn--vlfag-bsa.is'     => qr/MediaWiki/,
    'xn--var-xla.net'          => qr/Bjarmason/,
    'xn--vlfag-bsa.is'         => qr/MediaWiki/,
);

while (my ($domain, $content_like) = splice @tests, 0, 2) {
    delete $sites_enabled{$domain};
    my $test = <<TEST;
$TEMPLATE
WebTest->new(
    domain       => q[$domain],
    content_like => qr[$content_like],
)->run_tests;
TEST
    my $dir = "$Bin/gen/content-like";
    make_path($dir);
    open my $th, ">", "$dir/$domain.t";
    print $th $test;
    close $th;
}

for my $domain (sort keys %sites_enabled) {
    my $test = <<TEST;
$TEMPLATE
WebTest->new(
    domain       => q[$domain],
)->run_todo_test;
TEST
    my $dir = "$Bin/gen/content-like-TODO";
    make_path($dir);
    open my $th, ">", "$dir/$domain.t";
    print $th $test;
    close $th;
}

}
